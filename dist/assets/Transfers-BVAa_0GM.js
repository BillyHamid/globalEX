import{r as n,j as e}from"./react-PleRxLNr.js";import{u as q,c as H}from"./router-CwZiKTye.js";import{t as A,u as Z}from"./index-ByeexPDm.js";import{D as K}from"./DataTable-CWvM5oaM.js";import{X as Q,s as U,t as _,F as Y,a as G,i as O,A as L,R as $,j as D,S as ee,u as re,o as se,v as I,C as ae,g as z,w as te,x as ne,T as le}from"./lucide-DAQsc5bm.js";const ie=({transferId:a,transferReference:j,isOpen:y,onClose:g,onSuccess:x})=>{const[d,N]=n.useState(null),[v,p]=n.useState(""),[o,m]=n.useState(!1),[w,l]=n.useState(null),[C,u]=n.useState(null);if(!y)return null;const E=i=>{var P;const c=(P=i.target.files)==null?void 0:P[0];if(!c)return;if(!["image/jpeg","image/jpg","image/png","application/pdf"].includes(c.type)){l("Type de fichier non autorisé. Types acceptés: JPG, JPEG, PNG, PDF");return}if(c.size>5*1024*1024){l("Le fichier est trop volumineux. Taille maximale: 5 MB");return}if(N(c),l(null),c.type.startsWith("image/")){const F=new FileReader;F.onloadend=()=>{u(F.result)},F.readAsDataURL(c)}else u(null)},f=async()=>{if(!d){l("Le fichier de preuve est obligatoire");return}m(!0),l(null);try{await A.confirmWithProof(a,d,v),x(),g(),N(null),p(""),u(null)}catch(i){l(i.message||"Erreur lors de la confirmation")}finally{m(!1)}},b=()=>{o||(N(null),p(""),u(null),l(null),g())};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Confirmer la réception"}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Transfert: ",j]})]}),e.jsx("button",{onClick:b,disabled:o,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50",children:e.jsx(Q,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(U,{className:"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-amber-800",children:"Preuve de réception obligatoire"}),e.jsx("p",{className:"text-xs text-amber-700 mt-1",children:"Vous devez fournir une preuve (image ou PDF) pour confirmer que le bénéficiaire a bien reçu l'argent."})]})]})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(_,{className:"w-4 h-4 inline mr-1"}),"Fichier de preuve ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("div",{className:"mt-2",children:e.jsxs("label",{className:"flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center pt-5 pb-6",children:[e.jsx(_,{className:"w-8 h-8 mb-2 text-gray-400"}),e.jsxs("p",{className:"mb-2 text-sm text-gray-500",children:[e.jsx("span",{className:"font-semibold",children:"Cliquez pour téléverser"})," ou glissez-déposez"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"JPG, JPEG, PNG ou PDF (MAX. 5MB)"})]}),e.jsx("input",{type:"file",className:"hidden",accept:".jpg,.jpeg,.png,.pdf,image/jpeg,image/png,application/pdf",onChange:E,disabled:o})]})}),C&&e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"Aperçu:"}),e.jsx("img",{src:C,alt:"Preview",className:"max-w-full h-48 object-contain border border-gray-200 rounded-lg"})]}),d&&!C&&e.jsxs("div",{className:"mt-4 flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx(Y,{className:"w-5 h-5 text-gray-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:d.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[(d.size/1024/1024).toFixed(2)," MB"]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Commentaire (optionnel)"}),e.jsx("textarea",{value:v,onChange:i=>p(i.target.value),placeholder:"Ajouter un commentaire sur la confirmation...",rows:3,className:"w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 resize-none",disabled:o})]}),w&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(U,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-sm text-red-700",children:w})]})}),e.jsxs("div",{className:"flex items-center justify-end gap-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{onClick:b,disabled:o,className:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50",children:"Annuler"}),e.jsx("button",{onClick:f,disabled:!d||o,className:"px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:o?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-4 h-4 animate-spin"}),"Confirmation..."]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"w-4 h-4"}),"Confirmer la réception"]})})]})]})]})})},oe={cash:{label:"Espèces",color:"bg-amber-100 text-amber-800 border border-amber-200"},zelle:{label:"Zelle",color:"bg-purple-100 text-purple-800 border border-purple-200"},orange_money:{label:"Orange Money",color:"bg-orange-100 text-orange-800 border border-orange-200"},wave:{label:"Wave",color:"bg-cyan-100 text-cyan-800 border border-cyan-200"},bank_transfer:{label:"Virement bancaire",color:"bg-indigo-100 text-indigo-800 border border-indigo-200"}},M={pending:{label:"En attente",color:"bg-amber-100 text-amber-800",icon:ae},in_progress:{label:"En cours",color:"bg-purple-100 text-purple-800",icon:$},paid:{label:"Payé",color:"bg-emerald-100 text-emerald-800",icon:O},cancelled:{label:"Annulé",color:"bg-red-100 text-red-800",icon:I}},fe=()=>{const{user:a}=Z(),j=q(),[y]=H(),g=y.get("status"),[x,d]=n.useState([]),[N,v]=n.useState(!0),[p,o]=n.useState(null),[m,w]=n.useState(()=>g&&["pending","in_progress","paid","cancelled"].includes(g)?g:"all"),[l,C]=n.useState(""),[u,E]=n.useState(!1),[f,b]=n.useState(null);n.useEffect(()=>{const s=y.get("status");s&&["pending","in_progress","paid","cancelled"].includes(s)&&m!==s&&w(s)},[y]);const i=async(s=!1)=>{s?E(!0):v(!0),o(null);try{const r={limit:100};m!=="all"&&(r.status=m);const t=await A.getAll(r);d(t.data)}catch(r){console.error("Error fetching transfers:",r),o(r.message||"Erreur lors du chargement des transferts")}finally{v(!1),E(!1)}};n.useEffect(()=>{i()},[m]);const c=x.filter(s=>{if(l==="")return!0;const r=l.toLowerCase();return s.reference.toLowerCase().includes(r)||`${s.sender.firstName} ${s.sender.lastName}`.toLowerCase().includes(r)||`${s.beneficiary.firstName} ${s.beneficiary.lastName}`.toLowerCase().includes(r)||s.beneficiary.phone.includes(r)}),S={total:x.length,pending:x.filter(s=>s.status==="pending").length,paid:x.filter(s=>s.status==="paid").length,cancelled:x.filter(s=>s.status==="cancelled").length},P=(s,r)=>{b({isOpen:!0,transferId:s,reference:r})},F=async s=>{const r=prompt("Raison de l'annulation :");if(r!==null)try{await A.cancel(s,r),i(!0)}catch(t){alert(t.message||"Erreur lors de l'annulation")}},X=async(s,r)=>{if(confirm(`Êtes-vous sûr de vouloir supprimer le transfert ${r} ?

Cette action est irréversible.`))try{await A.delete(s),i(!0)}catch(t){alert(t.message||"Erreur lors de la suppression")}},J=s=>new Date(s).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),V=[{header:"Référence",accessor:"reference",render:s=>e.jsx("span",{className:"font-mono text-emerald-600 font-semibold text-sm",children:s})},{header:"Expéditeur",accessor:"sender",render:(s,r)=>e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900",children:[r.sender.firstName," ",r.sender.lastName]}),e.jsx("p",{className:"text-xs text-gray-500",children:r.sender.country})]})},{header:"Bénéficiaire",accessor:"beneficiary",render:(s,r)=>e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900",children:[r.beneficiary.firstName," ",r.beneficiary.lastName]}),e.jsx("p",{className:"text-xs text-gray-500",children:r.beneficiary.phone})]})},{header:"Montant envoyé",accessor:"amountSent",render:(s,r)=>e.jsxs("span",{className:"font-medium",children:[s.toLocaleString()," ",r.currencySent]})},{header:"Mode de paiement",accessor:"sendMethod",render:s=>{const r=s?oe[s]:null;return r?e.jsx("span",{className:`inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold ${r.color}`,children:r.label}):e.jsx("span",{className:"text-gray-400 text-sm",children:"—"})}},{header:"Taux du jour",accessor:"exchangeRate",render:(s,r)=>{if(r.sender.country==="BFA"&&r.beneficiary.country==="USA"){const h=(1/s).toFixed(4);return e.jsxs("span",{className:"text-sm text-gray-700",children:["1 XOF = ",h," ",r.currencyReceived]})}else return e.jsxs("span",{className:"text-sm text-gray-700",children:["1 ",r.currencySent," = ",s.toLocaleString()," ",r.currencyReceived]})}},{header:"À remettre",accessor:"amountReceived",render:(s,r)=>e.jsxs("span",{className:"font-bold text-emerald-600",children:[s.toLocaleString()," ",r.currencyReceived||"XOF"]})},{header:"Agent",accessor:"createdBy",render:(s,r)=>{var t;return e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:((t=r.createdBy)==null?void 0:t.name)??"—"}),r.paidBy&&e.jsxs("p",{className:"text-xs text-gray-500",title:"Payé par",children:["Payé par: ",r.paidBy.name]})]})}},{header:"Statut",accessor:"status",render:s=>{const r=M[s]||M.pending,t=r.icon;return e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${r.color}`,children:[e.jsx(t,{className:"w-3 h-3"}),r.label]})}},{header:"Date",accessor:"createdAt",render:s=>e.jsx("span",{className:"text-sm text-gray-600",children:J(s)})},{header:"Actions",accessor:"id",render:(s,r)=>{var B;const t=(B=r.createdBy)==null?void 0:B.country,h=a==null?void 0:a.country,k=r.status==="pending"&&((a==null?void 0:a.role)==="sender_agent"||(a==null?void 0:a.role)==="payer_agent"||(a==null?void 0:a.role)==="admin"||(a==null?void 0:a.role)==="supervisor");let T=!0;k&&t&&h&&(a==null?void 0:a.role)!=="admin"&&(a==null?void 0:a.role)!=="supervisor"&&((t==="BFA"||t==="Burkina Faso")&&!(h==="USA"||h==="États-Unis")||(t==="USA"||t==="États-Unis")&&!(h==="BFA"||h==="Burkina Faso"))&&(T=!1);const W=k&&T;return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{className:"p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",title:"Voir détails",onClick:()=>j(`/transfers/${r.id}`),children:e.jsx(z,{className:"w-4 h-4"})}),W&&e.jsx("button",{className:"p-2 text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors border border-emerald-200 bg-emerald-50",title:"Confirmer avec preuve (obligatoire)",onClick:()=>P(r.id,r.reference),children:e.jsx(te,{className:"w-4 h-4"})}),r.proofFilePath&&e.jsx("button",{className:"p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",title:"Voir la preuve",onClick:async()=>{try{await A.downloadProof(r.id)}catch(R){alert(R.message||"Erreur lors du téléchargement")}},children:e.jsx(z,{className:"w-4 h-4"})}),r.status==="pending"&&((a==null?void 0:a.role)==="admin"||(a==null?void 0:a.role)==="supervisor")&&e.jsx("button",{className:"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"Annuler",onClick:()=>F(r.id),children:e.jsx(ne,{className:"w-4 h-4"})}),(a==null?void 0:a.role)==="admin"&&e.jsx("button",{className:"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"Supprimer (admin uniquement)",onClick:()=>X(r.id,r.reference),children:e.jsx(le,{className:"w-4 h-4"})})]})}}];return a?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(L,{className:"w-7 h-7 text-emerald-600"}),"Transferts"]}),e.jsx("p",{className:"text-gray-600",children:"Gérez toutes les transactions de transfert"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>i(!0),disabled:u,className:"p-3 border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors",title:"Rafraîchir",children:e.jsx($,{className:`w-5 h-5 ${u?"animate-spin":""}`})}),(a.role==="admin"||a.role==="sender_agent"||a.role==="payer_agent")&&e.jsxs("button",{onClick:()=>j("/transfers/new"),className:"bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl font-medium flex items-center gap-2 shadow-lg shadow-emerald-500/30 transition-all",children:[e.jsx(D,{className:"w-5 h-5"}),"Nouvelle transaction"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-100 shadow-sm",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Total"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:S.total})]}),e.jsxs("div",{className:"bg-amber-50 rounded-xl p-4 border border-amber-100",children:[e.jsx("p",{className:"text-sm text-amber-600",children:"En attente"}),e.jsx("p",{className:"text-2xl font-bold text-amber-700",children:S.pending})]}),e.jsxs("div",{className:"bg-emerald-50 rounded-xl p-4 border border-emerald-100",children:[e.jsx("p",{className:"text-sm text-emerald-600",children:"Payés"}),e.jsx("p",{className:"text-2xl font-bold text-emerald-700",children:S.paid})]}),e.jsxs("div",{className:"bg-red-50 rounded-xl p-4 border border-red-100",children:[e.jsx("p",{className:"text-sm text-red-600",children:"Annulés"}),e.jsx("p",{className:"text-2xl font-bold text-red-700",children:S.cancelled})]})]}),e.jsx("div",{className:"bg-white rounded-xl p-4 border border-gray-100 shadow-sm",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(ee,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Rechercher par référence, expéditeur ou bénéficiaire...",value:l,onChange:s=>C(s.target.value),className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{className:"w-5 h-5 text-gray-400"}),e.jsxs("select",{value:m,onChange:s=>w(s.target.value),className:"px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500",children:[e.jsx("option",{value:"all",children:"Tous les statuts"}),e.jsx("option",{value:"pending",children:"En attente"}),e.jsx("option",{value:"in_progress",children:"En cours"}),e.jsx("option",{value:"paid",children:"Payé"}),e.jsx("option",{value:"cancelled",children:"Annulé"})]})]}),e.jsxs("button",{className:"px-4 py-3 border border-gray-300 rounded-xl hover:bg-gray-50 flex items-center gap-2 transition-colors",children:[e.jsx(se,{className:"w-5 h-5"}),"Exporter"]})]})}),N?e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 shadow-sm p-12 flex flex-col items-center justify-center",children:[e.jsx(G,{className:"w-8 h-8 text-emerald-600 animate-spin mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Chargement des transferts..."})]}):p?e.jsxs("div",{className:"bg-red-50 rounded-xl border border-red-100 p-6 text-center",children:[e.jsx(I,{className:"w-8 h-8 text-red-500 mx-auto mb-2"}),e.jsx("p",{className:"text-red-700",children:p}),e.jsx("button",{onClick:()=>i(),className:"mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"Réessayer"})]}):c.length===0?e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 shadow-sm p-12 text-center",children:[e.jsx(L,{className:"w-12 h-12 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 text-lg",children:"Aucun transfert trouvé"}),e.jsx("p",{className:"text-gray-400 mt-2",children:l?"Essayez de modifier votre recherche":"Créez votre premier transfert"}),!l&&((a==null?void 0:a.role)==="sender_agent"||(a==null?void 0:a.role)==="payer_agent")&&e.jsxs("button",{onClick:()=>j("/transfers/new"),className:"mt-4 bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl font-medium inline-flex items-center gap-2",children:[e.jsx(D,{className:"w-5 h-5"}),"Nouveau transfert"]})]}):e.jsx("div",{className:"bg-white rounded-xl border border-gray-100 shadow-sm overflow-x-auto max-w-full",children:e.jsx(K,{data:c,columns:V})}),f&&e.jsx(ie,{transferId:f.transferId,transferReference:f.reference,isOpen:f.isOpen,onClose:()=>b(null),onSuccess:()=>{i(!0),b(null)}})]}):null};export{fe as Transfers};
